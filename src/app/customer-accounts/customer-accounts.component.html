<div class="container py-4">
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-0 fw-bold text-dark">Customer Accounts</h4>
        <p class="text-muted small mb-0">Detailed view of all accounts for this client</p>
      </div>
      <a routerLink="/customers" class="btn btn-light btn-sm px-3 fw-bold text-muted">
        <i class="bi bi-arrow-left me-1"></i> Back to List
      </a>
    </div>
    <div class="card-body">
      <!-- Customer Info -->
      <div *ngIf="customer" class="card bg-primary text-white border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <div class="d-flex align-items-center">
            <div class="bg-white bg-opacity-25 rounded-circle p-3 me-4 d-flex align-items-center justify-content-center" style="width: 70px; height: 70px;">
              <i class="bi bi-person-check-fill fs-1"></i>
            </div>
            <div>
              <h2 class="fw-bold mb-1">{{customer.name}}</h2>
              <div class="d-flex align-items-center opacity-75">
                <i class="bi bi-envelope-fill me-2"></i> {{customer.email}}
                <span class="mx-2 opacity-50">|</span>
                <i class="bi bi-hash me-1"></i> ID: {{customer.id}}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Create Account Form Toggle -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold mb-0 text-dark">Linked Accounts</h5>
        <button class="btn btn-primary btn-sm px-3 shadow-sm" (click)="showCreateAccountForm = !showCreateAccountForm">
          <i class="bi bi-plus-lg me-1"></i> New Account
        </button>
      </div>

      <div *ngIf="showCreateAccountForm" class="card border-0 bg-light mb-4 animate__animated animate__fadeIn">
        <div class="card-body p-4">
          <h6 class="fw-bold mb-4 text-primary text-uppercase small letter-spacing-1">Create New Account</h6>
          <form [formGroup]="newAccountFormGroup" (ngSubmit)="handleCreateAccount()">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label small fw-bold">Account Type</label>
                <select formControlName="accountType" class="form-select form-select-sm border-0 shadow-sm">
                  <option value="CurrentAccount">Current Account</option>
                  <option value="SavingAccount">Saving Account</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small fw-bold">Initial Deposit (DH)</label>
                <div class="input-group input-group-sm shadow-sm">
                  <span class="input-group-text bg-white border-0">DH</span>
                  <input type="number" formControlName="initialBalance" class="form-control border-0" placeholder="0.00">
                </div>
              </div>
              <div class="col-md-4" *ngIf="newAccountFormGroup.get('accountType')?.value === 'SavingAccount'">
                <label class="form-label small fw-bold">Interest Rate (%)</label>
                <div class="input-group input-group-sm shadow-sm">
                  <input type="number" formControlName="interestRate" class="form-control border-0" placeholder="1.5">
                  <span class="input-group-text bg-white border-0">%</span>
                </div>
              </div>
              <div class="col-12 text-end mt-4">
                <button type="button" class="btn btn-link text-muted extra-small fw-bold text-decoration-none me-3" (click)="showCreateAccountForm = false">CANCEL</button>
                <button type="submit" class="btn btn-success btn-sm px-4 fw-bold shadow-sm" [disabled]="newAccountFormGroup.invalid">
                  ACTIVATE ACCOUNT
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <ng-container *ngIf="accounts$ | async as accounts; else loadingOrError">
        <div *ngIf="accounts.length === 0" class="text-center py-5 bg-light rounded shadow-sm border border-dashed">
          <i class="bi bi-wallet-fill fs-1 text-muted opacity-25"></i>
          <p class="mt-3 text-muted">No financial accounts associated with this client.</p>
        </div>

        <div class="table-responsive" *ngIf="accounts.length > 0">
          <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
              <tr class="extra-small text-muted text-uppercase">
                <th class="ps-4">Reference</th>
                <th>Type & Account</th>
                <th>Status</th>
                <th class="text-end">Balance</th>
                <th class="text-end pe-4">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let acc of accounts">
                <td class="ps-4">
                  <code class="extra-small text-primary bg-primary bg-opacity-10 px-2 py-1 rounded">{{acc.id | slice:0:18}}...</code>
                  <div class="extra-small text-muted mt-1"><i class="bi bi-clock me-1"></i>Created {{acc.createdAt | date:'shortDate'}}</div>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div [class]="acc.type === 'SavingAccount' ? 'bg-success bg-opacity-10 text-success' : 'bg-info bg-opacity-10 text-info'"
                         class="rounded p-2 me-3 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                      <i [class]="acc.type === 'SavingAccount' ? 'bi bi-piggy-bank' : 'bi bi-credit-card'"></i>
                    </div>
                    <div>
                      <div class="fw-bold small">{{acc.type === 'SavingAccount' ? 'Saving Account' : 'Current Account'}}</div>
                      <div class="extra-small text-muted">
                        {{acc.type === 'SavingAccount' ? 'Interest: ' + acc.interestRate + '%' : 'Overdraft: ' + (acc.overDraft | number:'1.2-2') + ' DH'}}
                      </div>
                    </div>
                  </div>
                </td>
                <td>
                  <span [ngClass]="acc.status === 'CREATED' ? 'badge bg-warning bg-opacity-10 text-warning' : (acc.status === 'ACTIVATED' ? 'badge bg-success bg-opacity-10 text-success' : 'badge bg-danger bg-opacity-10 text-danger')"
                        class="extra-small fw-bold border-0">
                    {{acc.status}}
                  </span>
                </td>
                <td class="text-end">
                  <div class="fw-bold text-dark">{{acc.balance | number:'1.2-2'}} <small class="text-muted fw-normal">DH</small></div>
                </td>
                <td class="text-end pe-4">
                  <div class="btn-group">
                    <button class="btn btn-outline-primary btn-sm border-0 rounded-pill mx-1" [routerLink]="['/account-details', acc.id]" title="Manage">
                      <i class="bi bi-gear-fill"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm border-0 rounded-pill mx-1" (click)="handleDeleteAccount(acc)" title="Delete">
                      <i class="bi bi-trash3-fill"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Summary Statistics -->
        <div *ngIf="accounts.length > 0" class="card border-0 bg-dark text-white mt-4 shadow-sm overflow-hidden">
          <div class="card-body p-0">
            <div class="row g-0 text-center">
              <div class="col-md-4 py-4 border-end border-white border-opacity-10">
                <p class="extra-small text-white text-opacity-50 text-uppercase mb-1 fw-bold">Total Accounts</p>
                <h3 class="mb-0 fw-bold">{{accounts.length}}</h3>
              </div>
              <div class="col-md-4 py-4 border-end border-white border-opacity-10">
                <p class="extra-small text-white text-opacity-50 text-uppercase mb-1 fw-bold">Net Liquidity</p>
                <h3 class="mb-0 fw-bold text-success">{{getTotalBalance(accounts) | number:'1.2-2'}} <small class="fs-6">DH</small></h3>
              </div>
              <div class="col-md-4 py-4">
                <p class="extra-small text-white text-opacity-50 text-uppercase mb-1 fw-bold">Avg. Account Balance</p>
                <h3 class="mb-0 fw-bold text-info">{{getTotalBalance(accounts) / accounts.length | number:'1.2-2'}} <small class="fs-6">DH</small></h3>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #loadingOrError>
        <ng-container *ngIf="errorMessage; else loading">
          <div class="alert alert-danger border-0 shadow-sm mx-auto mt-4" style="max-width: 600px;">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>{{errorMessage}}
          </div>
        </ng-container>
        <ng-template #loading>
          <div class="text-center py-5">
            <div class="spinner-border text-primary spinner-border-sm" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted small">Accessing core banking records...</p>
          </div>
        </ng-template>
      </ng-template>
    </div>
  </div>
</div>
